<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reward Verification</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;padding:30px;text-align:center;background:#f6f8fb}
  .card{max-width:520px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.07)}
  .btn{display:inline-block;background:#018AFF;color:#fff;padding:12px 28px;border-radius:8px;text-decoration:none;font-size:18px}
  p.small{color:#666;font-size:13px;margin-top:10px}
  pre{white-space:pre-wrap;text-align:left;font-size:12px;color:#333}
</style>
</head>
<body>
  <div class="card">
    <h2>You Have 1 Reward Pending</h2>
    <p>Verify your phone number to claim a free Amazon reward in your country.</p>
    <a id="continueBtn" class="btn" href="#">Continue</a>
    <p class="small">By clicking Continue you will be redirected to a secure verification page.</p>
    <pre id="debug" style="display:none;margin-top:12px"></pre>
  </div>

<script>
function parseBemobDataString(s){
  var obj = {};
  if(!s) return obj;
  var parts = s.split('..');
  parts.forEach(function(part){
    if(!part) return;
    var kv = part.split('=');
    var key = kv.shift();
    var value = kv.join('=');
    if(key && value !== undefined) obj[key] = value;
  });
  return obj;
}
function parseQueryToObj(q){
  var obj = {};
  if(!q) return obj;
  q = q.replace(/^\?/, '');
  q.split('&').forEach(function(pair){
    if(!pair) return;
    var kv = pair.split('=');
    var k = decodeURIComponent(kv.shift()||'');
    var v = decodeURIComponent(kv.join('=')||'');
    if(k) obj[k] = v;
  });
  return obj;
}
function getParam(name){
  var re = new RegExp('[?&]'+name+'=([^&#]*)', 'i');
  var m = window.location.href.match(re);
  return m ? decodeURIComponent(m[1]) : null;
}

function buildFinalUrl(parsed){
  // PRIORITIZE these keys based on your bemobdata:
  // - click id -> 'l' (primary), fallback 'c' or 'clickid'
  // - site/zone -> 'rl' (primary), fallback 'trafficSourceId' or 'site'
  var clickVal = parsed['l'] || parsed['clickid'] || parsed['c'] || parsed['cid'] || parsed['rl'];
  var siteVal  = parsed['rl'] || parsed['trafficSourceId'] || parsed['site'] || parsed['zoneid'] || parsed['s'];

  var base = 'https://www.wineisblue.support/click?offer_id=34505&pub_id=262916';
  var suffix = '';
  if(clickVal) suffix += '&pub_click_id=' + encodeURIComponent(clickVal);
  if(siteVal)  suffix += '&site=' + encodeURIComponent(siteVal);
  return base + suffix;
}

(function init(){
  var debugEl = document.getElementById('debug');

  var bem = getParam('bemobdata');
  var parsed = {};
  if(bem){
    try{ bem = decodeURIComponent(bem); }catch(e){}
    bem = bem.replace(/^#/, '');
    parsed = parseBemobDataString(bem);
  }
  // also include normal query params (if any)
  var qObj = parseQueryToObj(window.location.search);
  for(var k in qObj) if(qObj.hasOwnProperty(k)) parsed[k] = parsed[k] || qObj[k];

  // if still empty, check hash for bemobdata
  if(!bem && window.location.hash){
    var h = window.location.hash.replace(/^#/, '');
    try{ h = decodeURIComponent(h); }catch(e){}
    var match = h.match(/bemobdata=([^&]*)/i);
    if(match) parsed = Object.assign(parsed, parseBemobDataString(decodeURIComponent(match[1])));
  }

  var finalUrl = buildFinalUrl(parsed);
  var hasClick = finalUrl.indexOf('pub_click_id=') !== -1;
  var hasSite  = finalUrl.indexOf('&site=') !== -1;

  if(!hasClick || !hasSite){
    debugEl.style.display = 'block';
    debugEl.textContent = 'Parsed bemobdata: ' + JSON.stringify(parsed, null, 2) + '\n\nBuilt redirect: ' + finalUrl;
  } else {
    debugEl.style.display = 'none';
  }

  document.getElementById('continueBtn').addEventListener('click', function(e){
    e.preventDefault();
    window.location.href = finalUrl;
  }, false);

})();
</script>
</body>
</html>
